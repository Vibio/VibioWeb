<?php
require_once("ebay.lib.php");
require_once("ebay.api.php");
require_once("ebay_comm.lib.php");

function ebay_perm()
{
	return array(
		"ebay admin",
		"ebay link_account",
		"ebay search",
	);
}

function ebay_menu()
{
	return array(
		"admin/settings/ebay"	=> array(
			"title"				=> "eBay Integration",
			"description"		=> "Manage eBay integration settings: keys, api urls, api versions, etc.",
			"page callback"		=> "drupal_get_form",
			"access arguments"	=> array("ebay admin"),
			"page arguments"	=> array("ebay_admin"),
			"file"				=> "ebay.forms.php",
		),
		"ebay/ajax/service"		=> array(
			"page callback"		=> "ebay_ajax",
			"access callback"	=> "ebay_access",
			"access arguments"	=> array("ebay ajax"),
			"file"				=> "ebay.ajax.php",
			"type"				=> MENU_CALLBACK,
		),
	);
}

function ebay_theme(&$existing, $type, $theme, $path)
{
	return array(
		"ebay_link_account_init"	=> array(
			"arguments"	=> array("session_id" => false),
			"template"	=> "templates/ebay/link-account",
			"path"		=> drupal_get_path("theme", "vibio"),
		),
	);
}

function ebay_preprocess_user_profile(&$vars)
{
	$args = explode("/", $_GET['q']);
	$uid = $args[1];
	
	drupal_add_js("var user_profile_uid = $uid;", "inline");
	drupal_add_js("sites/all/themes/vibio/js/user-ebay.js");
}

function ebay_preprocess_ebay_link_account_init(&$vars)
{
	global $user;
	
	if (!$vars['session_id'])
	{
		$vars['session_id'] = ebay_get_session_id();
	}
	
	$sql = "REPLACE INTO {ebay_pending}
			(`uid`, `session_id`)
			VALUES
			(%d, '%s')";
	db_query($sql, $user->uid, $vars['session_id']);
}

function ebay_network_get_userinfo($uid)
{
	$sql = "SELECT `ebay_id`
			FROM {ebay_users}
			WHERE `uid`=%d";
	return array(
		"ebay_id"	=> db_result(db_query($sql, $uid)),
	);
}

function ebay_access($perm)
{
	return true;
}
?>