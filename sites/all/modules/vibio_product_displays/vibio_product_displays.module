<?php

include_once('vibio_product_displays.features.inc');

function vibio_product_displays_menu() {
  $items['home'] = array(
    'title' => t('Featured by Vibio'),
    'page callback' => 'vibio_product_displays_popular',
    'access arguments' => array('access content'),
  );
  $items['home/popular'] = array(
    'title' => t('Popular'),
    'description' => t('View products that people want and have the most.'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'page callback' => 'vibio_product_displays_popular',
    'access arguments' => array('access content'),
    'weight' => 0,
  );
  $items['home/featured'] = array(
    'title' => t('Featured'),
    'description' => t('View products we think are interesting.'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'page callback' => 'vibio_product_displays_featured',
    'access arguments' => array('access content'),
    'weight' => 0,
  );
  $items['home/for-sale'] = array(
    'title' => t('For sale'),
    'description' => t('View products that people have and are selling.'),
    'type' => MENU_LOCAL_TASK,
    'page callback' => 'vibio_product_displays_for_sale',
    'access arguments' => array('access content'),
    'weight' => 1,
  );
  $items['home/recent'] = array(
    'title' => t('Recent'),
    'description' => t("View products that have recently entered people's collections."),
    'type' => MENU_LOCAL_TASK,
    'page callback' => 'vibio_product_displays_recent',
    'access arguments' => array('access content'),
    'weight' => 2,
  );
  return $items;
}

function vibio_product_displays_block($op = 'list', $delta = 0, $edit = array()) {
  switch ($op) {
    case 'list':
      $blocks = array();
      $blocks['filter'] = array(
          'info' => t('Homepage category filter'),
          'cache' => BLOCK_NO_CACHE,
      );
      return $blocks;
      break;
    case 'configure':
      // TODO: Add setting for which URL argument is the term name. Defaults
      // to 1 right now.
      break;
    case 'save':
      break;
    case 'view':
      // This filter only shows up on the homepage.
      if ($delta == 'filter' && arg(0) == 'home') {
        $block['subject'] = t('Filter a Category');
        $block['content'] = vibio_product_displays_display_block_filter();
      }
      return $block;
      break;
  }
}

function vibio_product_displays_display_block_filter() {
  return drupal_get_form('vibio_product_displays_filter_form');
}

function vibio_product_displays_filter_form(&$form_state) {
  // Get a list of terms in the Category vocabulary
  $vid = vibio_product_displays_get_vocabulary_by_name('Category')->vid;
  $url_term = str_replace('-', ' ', check_plain(arg(1)));
  $selected_term = taxonomy_get_term_by_name($url_term);
  $selected_tid = $selected_term[0]->tid;
  $form['categories'] = taxonomy_form($vid, array($selected_tid));
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Go'),
  );
  return $form;
}

function vibio_product_displays_filter_form_submit($form, &$form_state) {
  // Convert the selected category into lowercase and replace spaces with dashes
  $term = taxonomy_get_term($form_state['values']['categories']);
  $term_name = $term->name;
  $url_argument = strtolower(str_replace(' ', '-', $term_name));
  // TODO: How do I make this preserve the Quicktabs tab? Should I read it from
  // $_GET?
  $form_state['redirect'] = array('home/' . $url_argument,
    drupal_query_string_encode($_GET, array('q')),
  );
}

function vibio_product_displays_popular() {
  $content = views_embed_view('popular_products', 'page');
  return $content;
}

function vibio_product_displays_featured() {
  $content = views_embed_view('flag_featured', 'page');
  return $content;
}

function vibio_product_displays_for_sale() {
  $content = views_embed_view('all_products_for_sale', 'page');
  return $content;
}

function vibio_product_displays_recent() {
  $content = views_embed_view('recent_products', 'page');
  return $content;
}

function vibio_product_displays_views_pre_render(&$view) {
  if ($view->name == 'all_products_for_sale' || $view->name == 'Wantlist') {
    $fid_alias = $view->field['field_main_image_fid']->field_alias;
    // Fake the _list and _data properties
    $fid_stub = substr($fid_alias, 0, -4);
    $fid_alias_fid = $fid_stub . '_fid';
    $fid_alias_list = $fid_alias . '_list';
    $fid_alias_data = $fid_alias . '_data';
    foreach ($view->result as $row) {
      if ($row->{$fid_alias_fid}) {
        continue;
      }
      else {
        // Grab the image from the parent product
        $product_nid = db_result(db_query("select product_nid from {product_items} where item_nid=%d", $row->nid));

        // Load the image, whatever it is

        $field = content_fields('field_main_image');
        $db_info = content_database_info($field);
        $table = $db_info['table'];
        $fid_col = $db_info['columns']['fid']['column'];
        $list_col = $db_info['columns']['list']['column'];
        $data_col = $db_info['columns']['data']['column'];
        $product_image_row = db_fetch_object(db_query("select $fid_col, $list_col, $data_col from {%s}
            where nid = %d", $table, $product_nid));
        $row->{$fid_alias_fid} = $product_image_row->{$fid_col};
        $row->{$fid_alias_list} = $product_image_row->{$list_col};
        $row->{$fid_alias_data} = $product_image_row->{$data_col};
      }
    }
  }
}

function vibio_product_displays_form_views_exposed_form_popular_products_alter(&$form, &$form_state) {
  $form['#action'] = request_uri();
}

function computed_field_field_item_count_compute($node, $field, &$node_field) {
  $node_field[0]['value'] = (int) db_result(db_query("select count(item_nid) from {product_items} where product_nid = %d", $node->nid));
}

function computed_field_field_item_count_display($field, $element, $node) {
  return $element['#item']['value'];
}

function _vibio_product_displays_homepage_print_google_conversion_code() {
  // code to track users who click ad, and then are logged in
  // assumed to be new users
  $conversion = '<!-- Google Code for Sign Up Conversion Page -->
    <script type="text/javascript">
      /* <![CDATA[ */
      var google_conversion_id = 1017452623;
      var google_conversion_language = "en";
      var google_conversion_format = "3";
      var google_conversion_color = "ffffff";
      var google_conversion_label = "J8y9CLGRqgIQz7CU5QM";
      var google_conversion_value = 0;
      /* ]]> */
    </script>
    <script type="text/javascript" src="http://www.googleadservices.com/pagead/conversion.js">
    </script>
    <noscript>
      <div style="display:inline;">
      <img height="1" width="1" style="border-style:none;" alt="" src="http://www.googleadservices.com/pagead/conversion/1017452623/?label=J8y9CLGRqgIQz7CU5QM&guid=ON&script=0"/>
      </div>
    </noscript>';

    return $conversion;
}

/**
 * This function will return a vocabulary object which matches the
 * given name. Will return null if no such vocabulary exists.
 *
 * @param String $vocabulary_name
 *   This is the name of the section which is required
 * @return Object
 *   This is the vocabulary object with the name
 *   or null if no such vocabulary exists
 */
function vibio_product_displays_get_vocabulary_by_name($vocabulary_name) {
  $vocabs = taxonomy_get_vocabularies(NULL);
  foreach ($vocabs as $vocab_object) {
    if ($vocab_object->name == $vocabulary_name) {
      return $vocab_object;
    }
  }
  return NULL;
}
