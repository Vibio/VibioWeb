<?php
require_once("vibio_item.inc.php");

define("VIBIO_ITEM_TYPE_OWN", 1);
define("VIBIO_ITEM_TYPE_SELL", 2);

function vibio_item_menu()
{
	return array(
		"user-inventory/%/search"	=> array(
			"page callback"		=> "vibio_item_user_inventory_search_results",
			"page arguments"	=> array(1),
			"access arguments"	=> array("access content"),
			"type"				=> MENU_CALLBACK,
			"file"				=> "vibio_item.pages.php",
		),
	);
}

function vibio_item_form_system_file_system_settings_alter(&$form, &$state)
{
	$x = 1;
}

function vibio_item_form_alter(&$form, &$state, $id)
{
	global $user;
	
	if ($id == "vibio_item_node_form")
	{	
		_vibio_item_unset($form);
		_vibio_item_defaults($form);
	}
	elseif ($id == "search_form" && $form['module']['#value'] == "vibio_item" && $user->uid > 0 && !module_exists("product"))
	{
		$options = _vibio_item_user_options();
		if (!empty($form['#parameters'][3]))
		{
			preg_match('/(\s+)users:([a-z]+)/i', $form['#parameters'][3], $defaults);
			$default_user_option = array_flip($options);
			$default_user_option = $defaults[2];
		}
		
		$form['vibio_advanced'] = array(
			"#type"			=> "fieldset",
			"#title"		=> t("Advanced"),
			"#collapsible"	=> true,
			"#collapsed"	=> false,
			"search_users"	=> array(
				"#type"			=> "select",
				"#title"		=> t("Search Users"),
				"#options"		=> $options,
				"#default_value"=> $default_user_option,
			),
		);
		
		$form["#validate"][] = "vibio_item_search_validate";
	}
	elseif ($id == "search_theme_form")
	{
		$form['#submit'][] = "vibio_item_search_submit";
	}
}

function vibio_item_search_validate($form, &$state)
{
	$vals = &$state['values'];
	$keys = $vals['processed_keys'];
	$user_options = _vibio_item_user_options();
	
	if (array_key_exists($vals['search_users'], $user_options))
	{
		$keys = preg_replace('/(\s+)users:([a-z]+)/i', '', $keys); //remove any existing value
		$keys .= " users:{$vals['search_users']} ";
	}
	
	form_set_value($form['basic']['inline']['processed_keys'], urldecode(trim($keys)), $state);
}

function vibio_item_search($op="search", $keys=null)
{
	switch ($op)
	{
		case "name":
			return t("Vibio");
		case "search":
			return _vibio_item_search($keys);
	}
}

//this is how i change the default tab
function vibio_item_search_submit($form, &$state)
{
	$form_id = $form['form_id']['#value'];
	$state['redirect'] = 'search/vibio_item/'.trim($state['values'][$form_id]);
}

function vibio_item_preprocess_node(&$vars)
{
	if (!$vars['teaser'] && $vars['node']->type == "vibio_item" && !_vibio_item_access($vars['node']))
	{
		$referrer = !empty($_SERVER['HTTP_REFERER']) ? $_SERVER['HTTP_REFERER'] : '';
		drupal_set_message(t("The owner has decided not to show that item"), "error");
		drupal_goto($referrer);
	}
}

function vibio_item_user_inventory_search(&$state, $uid)
{
	return array(
		"inventory_uid"	=> array(
			"#type"	=> "hidden",
			"#value"=> $uid,
		),
		"phrase"		=> array(
			"#title"=> t("Item Name"),
			"#type"	=> "textfield",
			"#size"	=> 24,
		),
		"item_status"	=> array(
			"#title"	=> t("Item Status"),
			"#type"		=> "select",
			"#options"	=> array(
				0	=> t("Any"),
				VIBIO_ITEM_TYPE_OWN		=> t("Own"),
				VIBIO_ITEM_TYPE_SELL	=> t("For Sale"),
			),
		),
		"submit"	=> array(
			"#type"	=> "submit",
			"#value"=> t("search"),
		),
	);
}
?>