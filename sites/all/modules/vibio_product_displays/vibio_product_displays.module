<?php

include_once('vibio_product_displays.features.inc');

function vibio_product_displays_menu() {
  $items['for-sale'] = array(
    'title' => t('For Sale'),
    'description' => t('View products that people have and are selling.'),
    'type' => MENU_NORMAL,
    'page callback' => 'vibio_product_displays_for_sale',
    'access callback' => 'user_is_logged_in',
  );
  $items['recent'] = array(
    'title' => t('Recent'),
    'description' => t("View products that have recently entered people's collections."),
    'type' => MENU_NORMAL,
    'page callback' => 'vibio_product_displays_recent',
    'access callback' => 'user_is_logged_in',
  );
  return $items;
}

function vibio_product_displays_for_sale() {
  $content = views_embed_view('all_products_for_sale', 'page');
  return $content;
}

function vibio_product_displays_recent() {
  $content = views_embed_view('recent_products', 'page');
  return $content;
}

function vibio_product_displays_views_pre_render(&$view) {
  if ($view->name == 'all_products_for_sale' || $view->name == 'Wantlist') {
    $fid_alias = $view->field['field_main_image_fid']->field_alias;
    // Fake the _list and _data properties
    $fid_stub = substr($fid_alias, 0, -4);
    $fid_alias_fid = $fid_stub . '_fid';
    $fid_alias_list = $fid_alias . '_list';
    $fid_alias_data = $fid_alias . '_data';
    foreach ($view->result as $row) {
      if ($row->{$fid_alias_fid}) {
        continue;
      }
      else {
        // Grab the image from the parent product
        $product_nid = db_result(db_query("select product_nid from {product_items} where item_nid=%d", $row->nid));

        // Load the image, whatever it is

        $field = content_fields('field_main_image');
        $db_info = content_database_info($field);
        $table = $db_info['table'];
        $fid_col = $db_info['columns']['fid']['column'];
        $list_col = $db_info['columns']['list']['column'];
        $data_col = $db_info['columns']['data']['column'];
        $product_image_row = db_fetch_object(db_query("select $fid_col, $list_col, $data_col from {%s}
            where nid = %d", $table, $product_nid));
        $row->{$fid_alias_fid} = $product_image_row->{$fid_col};
        $row->{$fid_alias_list} = $product_image_row->{$list_col};
        $row->{$fid_alias_data} = $product_image_row->{$data_col};
      }
    }
  }
}

function _vibio_product_displays_compare_item_counts($row1, $row2) {
  $sql = "SELECT COUNT(item_nid) FROM {product_items} WHERE product_nid = %d GROUP BY product_nid";
  $row1_count = (int) db_result(db_query($sql, $row1->nid)); 
  $row2_count = (int) db_result(db_query($sql, $row2->nid)); 
  if ($row1_count > $row2_count) {
    return 1;
  }
  elseif ($row1_count == $row2_count) {
    return 0;
  }
  else {
    return -1;
  }
}

